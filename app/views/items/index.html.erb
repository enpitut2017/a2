<% if flash[:notice] %>
  <p><%= flash[:notice] %></p>
<% end %>
<% if flash[:alert] %>
  <p><%= flash[:alert] %></p>
<% end %>

        <h1>商品一覧</h1>
        <ul class="collapsible" data-collapsible="accordion">
          <li>
            <div class="collapsible-header"><i class="material-icons left">search</i>検索・絞り込み</div>
            <div class="collapsible-body">
              <form>
                <div class="row">
                  <div class="input-field">
<% if params["freeword_select"] == nil then @fwd_default = "" else @fwd_default = params["freeword_select"] end %>
                    <input type="text" id="freeword_select" name="freeword_select" value="<%= @fwd_default %>">
                    <label for="freeword_select" class="active">フリーワード</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field">
                    <select name="department_select">
<% @departments = Department.all %>
<% if params["department_select"] == nil || params["department_select"] == 0 %>
                      <option value="0" selected>指定しない</option>
<% else %>
                      <option value="0">指定しない</option>
<% end %>
<% @departments.each do |dep| %>
  <% if params["department_select"] == dep.id.to_s %>
                      <option value="<%= dep.id %>" selected><%= dep.name %></option>
<% else %>
                      <option value="<%= dep.id %>"><%= dep.name %></option>
  <% end %>
<% end %>
                    </select>
                    <label>所属</label>
                  </div>
                </div>
                <div class="row flex flex-wrap">
<% @places = Place.all %>
<% @places.each do |pla| %>
                  <span>
  <% if params["place_check"] != nil && params["place_check"][pla.id.to_s] == "true" %>
                    <%= check_box 'place_check', pla.id, {:checked => "checked"}, true, false %>
  <% else %>
                    <%= check_box 'place_check', pla.id, {}, true, false %>
  <% end %>
                    <label for="place_check_<%= pla.id %>"><%= pla.name %></label>
                  </span>
<% end %>
                </div>
                <div class="row">
                  <a class="btn" href="javascript:window.open('/map', 'map');">地図から選択</a>
                </div>
                <div class="row">
                  <div class="input-field">
                    <select name="sort_type">
<% if params["sort_type"] == '1' %>
                      <option value="0">新しい順に表示</option>
                      <option value="1" selected>価格の安い順に表示</option>
<% else %>
                      <option value="0" selected>新しい順に表示</option>
                      <option value="1">価格の安い順に表示</option>
<% end %>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <input type="submit" value="検索" class="btn">
                </div>
              </form>
            </div>
          </li>
        </ul>

<% @genres = Genre.all %>




<h2>商品一覧</h2>
<!--検索機能-->
<div class="search">
  <form name="search_form" method="get">
    <table class="search_form">
      <tbody class="toggle_container" data-toggle-id="search">
        <% @genres = Genre.all %>
        <tr>
          <td colspan="2" style="text-align: center;"><input type="submit" value="検索" class="color_btn"></td>
        </tr>
      </tbody>
    </table>
  </form>
</div>

<% @sort_str = "" %>
<% if params["sort_type"] == '0' || params["sort_type"] == nil%>
  <% @items = Item.order('created_at DESC').where(activated: true) %>
  <% @sort_str = "新しい順に表示" %>
<% elsif params["sort_type"] == '1' %>
  <% @items = Item.order('price ASC').where(activated: true) %>
  <% @sort_str = "価格順に表示" %>
<% end %>


<% if params["freeword_select"] != "" && params["freeword_select"] != nil %>
  <% @items = @items.where("name like(?) or detail like(?)", "%#{params['freeword_select']}%" , "%#{params['freeword_select']}%") %>
<% end %>
<% if params["department_select"].to_i > 0 %>
  <% @items = @items.where(department_id: params["department_select"]) %>
<% end %>
<% if params["genre_select"].to_i > 0 %>
  <% @items = @items.where(genre_id: params["genre_select"]) %>
<% end %>
<% if params["place_check"] != nil %>
  <% @place_check_id = [] %>
  <% for i in 1..@places.length %>
    <% if params["place_check"][i.to_s] %>
    <% @place_check_id << i %>
    <% end %>
  <% end %>
  <% @items = @items.where(place_id: @place_check_id) %>
<% else%>
  <% @place_check_id = [] %>
<% end %>

<%
@dep = "指定しない"
@gen = "指定しない"
@pla = "指定しない"
@key = "指定しない"

if params["department_select"] != "0" && params["department_select"] != nil
  @dep = @departments[params["department_select"].to_i - 1].name
end
if params["genre_select"] != "0" && params["genre_select"] != nil
  @gen = @genres[params["genre_select"].to_i - 1].name
end

if @place_check_id.length > 0
  @pla = @places[@place_check_id[0] - 1].name
  for i in 1..@place_check_id.length-1
    @pla = @pla + "・" + @places[@place_check_id[i]-1].name
  end
end

if params["freeword_select"] != "" && params["freeword_select"] != nil
  @key = params["freeword_select"]
end
%>

<h3>現在の検索条件</h3>
<p><span style="display: inline-block;">【並び替え：<strong><%= @sort_str %></strong>】</span><span style="display: inline-block;">【キーワード：<strong><%= @key %></strong>】</span><span style="display: inline-block;">【所属：<strong><%= @dep %></strong>】</span><span style="display: inline-block;">【場所：<strong><%= @pla %></strong>】</span></p>


<!-- タブ -->
<% if params["genre"] ==  nil %>
  <% params["genre"] = "0" %>
<% end %>

<div class="genre_tab">
  <form name="genre_form" method="get" class="genre_tab_item">
    <input type="hidden" name="genre" value="0">
    <% if params["genre"] == "0" %>
      <input type="submit" value="全ての商品" class="genre_tab_item_active">
    <% else %>
      <input type="submit" value="全ての商品" class="genre_tab_item_inactive">
    <% end %>
  </form>
  <% @genres.each do |gen| %>
    <form name="genre_form" method="get" class="genre_tab_item">
      <input type="hidden" name="genre" value=<%=gen.id%>>
      <% if params["genre"] == gen.id.to_s %>
        <input type="submit" value=<%=gen.name%> class="genre_tab_item_active">
      <% else %>
        <input type="submit" value=<%=gen.name%> class="genre_tab_item_inactive">
      <% end %>
    </form>
  <% end %>
</div>
<% if params["genre"] != "0" %>
  <% @items = @items.where(genre_id: params["genre"]) %>
<% end %>


<h3>検索結果</h3>
<p><span class="match_num"><%= @items.length %></span>件の商品</p>

<% @items.each do |item| %>
  <% if item.sold != 8181 %>
    <div class="item_table">
        <div class="thumb_img_square">
        <div class="relative">
          <% if item.image? %>
            <%= link_to item do %><%= image_tag item.image.url, :class=>"sold_over_black" %><% end %>
          <% else %>
            <%= link_to item do %><%= image_tag 'no_image.png', :class=>"sold_over_black" %><% end %>
          <% end %>

          <% if Time.current - item.created_at < 3600 * 24 %>
            <%= link_to item, :class=>"sold_over_ribbon" do%><%= image_tag 'new_over_ribbon.png'%><% end %>
          <% end %>
        </div>
      </div>
      <div class="cell_label name">商品名</div>
      <div class="data_cell"><%= link_to item.name, item %></div>
      <div class="cell_label price">価格</div>
      <div class="data_cell"><%= number_with_delimiter(item.price) %> 円</div>
      <div class="cell_label place">地域</div>
      <div class="data_cell"><%= item.place.name %></div>
    </div>
  <% end %>
<% end %>

<% @items.each do |item| %>
  <% if item.sold == 8181 %>
    <div class="item_table">
      <div class="thumb_img_square">
        <div class="relative">
            <% if item.image? %>
              <%= link_to item do %><%= image_tag item.image.url, :class=>"sold_over_black" %><% end %>
            <% else %>
              <%= link_to item do %><%= image_tag 'no_image.png', :class=>"sold_over_black" %><% end %>
            <% end %>

            <%= link_to item, :class=>"sold_over_black" do%><%= image_tag 'soldout_over_black.png'%><% end %>
            <%= link_to item, :class=>"sold_over_ribbon" do%><%= image_tag 'soldout_over_ribbon.png'%><% end %>
        </div>
      </div>
      <div class="cell_label name">商品名</div>
      <div class="data_cell"><%= link_to item.name, item %></div>
      <div class="cell_label price">価格</div>
      <div class="data_cell"><%= number_with_delimiter(item.price) %> 円</div>
      <div class="cell_label place">地域</div>
      <div class="data_cell"><%= item.place.name %></div>
    </div>
  <% end %>
<% end %>
